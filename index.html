<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liquid Dance Revival - Festival de Danza en el Agua</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        :root {
            --color-primary: #2c3e50;
            --color-secondary: #3498db;
            --color-accent: #e74c3c;
            --color-light: #ecf0f1;
            --color-dark: #2c3e50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            line-height: 1.6;
            color: var(--color-dark);
            background-color: var(--color-light);
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background-color: var(--color-primary);
            color: white;
            padding: 1rem;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .logo span {
            color: var(--color-accent);
        }

        .language-selector {
            display: flex;
            gap: 10px;
        }

        .lang-btn {
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        .lang-btn.active {
            background-color: white;
            color: var(--color-primary);
        }

        .subtitle {
            font-size: 1rem;
            font-weight: 300;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .filters-panel {
            width: 320px;
            background: white;
            padding: 1.5rem;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .filter-section {
            margin-bottom: 1.5rem;
        }

        .filter-section h3 {
            margin-bottom: 0.8rem;
            color: var(--color-primary);
            font-size: 1.1rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .clear-btn {
            background: none;
            border: none;
            color: var(--color-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            text-decoration: underline;
        }

        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-option input {
            cursor: pointer;
        }

        .filter-option label {
            cursor: pointer;
            font-size: 0.9rem;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 200px;
        }

        .legend h4 {
            margin-bottom: 8px;
            color: var(--color-primary);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 5px;
            flex-shrink: 0;
        }

        /* Modal para mostrar fotos */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 95%;
            max-width: 1200px;
            height: 90%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            cursor: pointer;
            color: var(--color-dark);
            z-index: 2001;
            background: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .location-title {
            margin-bottom: 15px;
            color: var(--color-primary);
            text-align: center;
            padding-right: 40px;
        }

        .photos-container {
            display: flex;
            flex: 1;
            gap: 20px;
            overflow: hidden;
        }

        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            overflow-y: auto;
            max-width: 50%;
            padding-right: 10px;
        }

        .photo-thumb {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .photo-thumb:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .photo-thumb.active {
            border: 3px solid var(--color-accent);
        }

        .photo-viewer {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        #toggle-metadata {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        .photo-viewer img {
            width: 100%;
            max-height: 60vh;
            object-fit: contain;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .photo-metadata {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .metadata-row {
            display: flex;
            margin-bottom: 8px;
        }

        .metadata-label {
            font-weight: 600;
            min-width: 80px;
            color: var(--color-primary);
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .nav-btn {
            background-color: var(--color-secondary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
        }

        .nav-btn:hover {
            background-color: var(--color-primary);
        }

        /* Responsive */
        @media (max-width: 992px) {
            .photos-container {
                flex-direction: column;
            }
            
            .photos-grid {
                max-width: 100%;
                max-height: 200px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .filters-panel {
                width: 100%;
                max-height: 300px;
            }
            
            .modal-content {
                padding: 15px;
            }
            
            .photos-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <div class="logo">Liquid Dance <span>Revival</span></div>
                <div class="subtitle" id="subtitle">Festival de Danza en el Agua - Ibiza 2023</div>
            </div>
            <div class="language-selector">
                <button class="lang-btn active" id="lang-es">ES</button>
                <button class="lang-btn" id="lang-en">EN</button>
            </div>
        </header>
        
        <div class="main-content">
            <div class="filters-panel">
                <div class="filter-section">
                    <h3>
                        <span id="days-title">Días del Festival</span>
                        <button class="clear-btn" id="clear-days" style="display: none;">Deseleccionar</button>
                    </h3>
                    <div class="filter-options" id="day-filters">
                        <!-- Días generados por JavaScript -->
                    </div>
                </div>
                
                <div class="filter-section">
                    <h3>
                        <span id="activities-title">Actividades</span>
                        <button class="clear-btn" id="clear-activities" style="display: none;">Deseleccionar</button>
                    </h3>
                    <div class="filter-options" id="activity-filters">
                        <!-- Actividades generadas por JavaScript -->
                    </div>
                </div>
                
                <div class="filter-section">
                    <h3>
                        <span id="participants-title">Participantes</span>
                        <button class="clear-btn" id="clear-participants" style="display: none;">Deseleccionar</button>
                    </h3>
                    <div class="search-box">
                        <input type="text" id="participant-search" placeholder="Buscar participante...">
                    </div>
                    <div class="filter-options" id="participant-filters">
                        <!-- Participantes generados por JavaScript -->
                    </div>
                </div>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
                
                <div class="legend">
                    <h4 id="legend-title">Leyenda</h4>
                    <div id="legend-items">
                        <!-- Elementos de leyenda generados por JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para mostrar fotos -->
    <div class="modal" id="photo-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 class="location-title" id="modal-location-title"></h2>
            
            <div class="photos-container">
                <div class="photos-grid" id="photos-grid">
                    <!-- Miniaturas de fotos generadas por JavaScript -->
                </div>
                
                <div class="photo-viewer" id="photo-viewer">
                    <div class="viewer-header">
                        <span id="photo-counter"></span>
                        <button id="toggle-metadata">Mostrar info</button>
                    </div>
                    <img id="large-photo" src="" alt="Foto del evento">
                    <div class="photo-metadata" id="photo-metadata">
                        <div class="metadata-row">
                            <span class="metadata-label">Fecha:</span>
                            <span id="metadata-date"></span>
                        </div>
                        <div class="metadata-row">
                            <span class="metadata-label">Lugar:</span>
                            <span id="metadata-place"></span>
                        </div>
                        <div class="metadata-row">
                            <span class="metadata-label">Actividad:</span>
                            <span id="metadata-activity"></span>
                        </div>
                        <div class="metadata-row">
                            <span class="metadata-label">Personas:</span>
                            <span id="metadata-people"></span>
                        </div>
                    </div>
                    <div class="nav-buttons">
                        <button class="nav-btn" id="prev-photo">← Anterior</button>
                        <button class="nav-btn" id="next-photo">Siguiente →</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script>
        // ================================
        // CONFIGURACIÓN Y DATOS
        // ================================
        
        // Textos en diferentes idiomas
        const translations = {
            es: {
                subtitle: "Festival de Danza en el Agua - Ibiza 2023",
                daysTitle: "Días del Festival",
                activitiesTitle: "Actividades",
                participantsTitle: "Participantes",
                legendTitle: "Leyenda - Día ",
                clearAll: "Deseleccionar",
                searchPlaceholder: "Buscar participante...",
                showInfo: "Mostrar info",
                hideInfo: "Ocultar info",
                previous: "← Anterior",
                next: "Siguiente →",
                date: "Fecha",
                place: "Lugar",
                activity: "Actividad",
                people: "Personas",
                noPhotos: "No hay fotos para esta actividad"
            },
            en: {
                subtitle: "Water Dance Festival - Ibiza 2023",
                daysTitle: "Festival Days",
                activitiesTitle: "Activities",
                participantsTitle: "Participants",
                legendTitle: "Legend - Day ",
                clearAll: "Deselect all",
                searchPlaceholder: "Search participant...",
                showInfo: "Show info",
                hideInfo: "Hide info",
                previous: "← Previous",
                next: "Next →",
                date: "Date",
                place: "Place",
                activity: "Activity",
                people: "People",
                noPhotos: "No photos for this activity"
            }
        };

        // Lista de participantes
        const allParticipants = [
            "Aitor", "Alex", "Anabel", "Andreas", "Andrew", "Annick", 
            "Anuja", "Blanca", "Claudia", "Diaana", "Dóri", "Francesco", 
            "Germán", "Jessi", "Karenina", "Laura", "Marga", "Martín", 
            "Nadia", "Natalia", "Pareja", "Riki", "Tanja", "Willem", "Zara", "Nati"
        ];

        // Datos de actividades (extraídos del CSV)
        const allActivities = [
            {
                id: "0100",
                date: "06/08/25",
                day: 1,
                activity: "Arrive to the accomondations",
                activity_es: "Llegada al alojamiento",
                place: "",
                lat: null,
                lng: null,
                participants: []
            },
            {
                id: "0101",
                date: "06/08/25",
                day: 1,
                activity: "Opening Circle",
                activity_es: "Círculo de apertura",
                place: "Bosque Cala Pada",
                lat: 38.99322,
                lng: 1.56329,
                participants: []
            },
            {
                id: "0102",
                date: "06/08/25",
                day: 1,
                activity: "Journey into the flow",
                activity_es: "Viaje hacia la fluidez",
                place: "Cala Pada",
                lat: 38.99327,
                lng: 1.56183,
                participants: ["Martin", "Tanja"]
            },
            {
                id: "0201",
                date: "07/08/25",
                day: 2,
                activity: "Awaken Flow - Yoga & playful connection",
                activity_es: "Despertar del flujo - Yoga y conexión lúdica",
                place: "Playa S'Arenal Petit, Portinatx",
                lat: 39.10877,
                lng: 1.51521,
                participants: ["Zara"]
            },
            {
                id: "0202",
                date: "07/08/25",
                day: 2,
                activity: "Water-Rebozo",
                activity_es: "Rebozo de agua",
                place: "",
                lat: null,
                lng: null,
                participants: ["Anuja"]
            },
            {
                id: "0206",
                date: "07/08/25",
                day: 2,
                activity: "Introduction Soma-Water Dance in Pool",
                activity_es: "Introducción a la danza Soma-Agua en la piscina",
                place: "Willem",
                lat: 39.00181,
                lng: 1.54227,
                participants: ["Martin"]
            },
            {
                id: "0207",
                date: "07/08/25",
                day: 2,
                activity: "Ecstatic Dance",
                activity_es: "Danza extática",
                place: "",
                lat: null,
                lng: null,
                participants: ["Willem"]
            },
            {
                id: "0301",
                date: "08/08/25",
                day: 3,
                activity: "Morning Practice",
                activity_es: "Práctica matutina",
                place: "Cala Benirràs",
                lat: 39.08958,
                lng: 1.45463,
                participants: ["Anuja"]
            },
            {
                id: "0304",
                date: "08/08/25",
                day: 3,
                activity: "Deep Dance Swarm among the sea weed",
                activity_es: "Danza profunda Enjambre entre las algas",
                place: "",
                lat: null,
                lng: null,
                participants: ["Alex"]
            },
            {
                id: "0401",
                date: "09/08/25",
                day: 4,
                activity: "Morning Practice - Soma & Voice",
                activity_es: "Práctica matutina - Soma y voz",
                place: "ses Salines",
                lat: 38.83970,
                lng: 1.39704,
                participants: ["Riki"]
            },
            {
                id: "0402",
                date: "09/08/25",
                day: 4,
                activity: "Partner-Water-Dance",
                activity_es: "Danza en pareja en el agua",
                place: "Cala Pluma",
                lat: 38.83574,
                lng: 1.40067,
                participants: ["Alex"]
            },
            {
                id: "0404",
                date: "09/08/25",
                day: 4,
                activity: "Contact Improv and Water Rebozo",
                activity_es: "Contact Improvisación y Rebozo de agua",
                place: "",
                lat: null,
                lng: null,
                participants: ["Anuja"]
            },
            {
                id: "0405",
                date: "09/08/25",
                day: 4,
                activity: "Water Blessing Ceremony & Sunset Jam",
                activity_es: "Ceremonia de bendición del agua y jam al atardecer",
                place: "",
                lat: null,
                lng: null,
                participants: ["Nati"]
            },
            {
                id: "0501",
                date: "10/08/25",
                day: 5,
                activity: "Moving, Sharing, Caring, Dancing, Flowing & Closing",
                activity_es: "Moviéndose, compartiendo, cuidando, bailando, fluyendo y cerrando",
                place: "sa Caleta",
                lat: 38.87005,
                lng: 1.33973,
                participants: []
            }
        ];

        // Filtrar solo actividades con ubicación
        const activitiesWithLocation = allActivities.filter(activity => activity.lat && activity.lng);

        // ================================
        // VARIABLES GLOBALES
        // ================================
        let currentLanguage = 'es';
        let currentLocationId = null;
        let currentPhotos = [];
        let currentPhotoIndex = 0;
        let activeFilters = {
            days: [],
            activities: [],
            participants: []
        };
        let markersCluster = null;

        // ================================
        // INICIALIZACIÓN DEL MAPA
        // ================================
        const map = L.map('map').setView([38.98, 1.30], 10);
        
        // Añadir capa del mapa
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Capa para los marcadores (usando clustering)
        markersCluster = L.markerClusterGroup({
            maxClusterRadius: 40,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
        });
        map.addLayer(markersCluster);

        // ================================
        // FUNCIONES PRINCIPALES
        // ================================

        // Generar colores únicos para actividades
        function generateActivityColors(activities) {
            const activityTypes = [...new Set(activities.map(a => a.activity))];
            const colors = [
                '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
                '#1abc9c', '#34495e', '#e67e22', '#27ae60', '#8e44ad'
            ];
            
            const colorMap = {};
            activityTypes.forEach((type, i) => {
                colorMap[type] = colors[i % colors.length];
            });
            
            return colorMap;
        }

        // Generar todos los filtros
        function generateFilters() {
            generateDayFilters();
            generateActivityFilters();
            generateParticipantFilters();
            setupClearButtons();
            setupLanguageToggle();
        }

        // Generar filtros por día
        function generateDayFilters() {
            const dayFilters = document.getElementById('day-filters');
            const uniqueDays = [...new Set(activitiesWithLocation.map(a => a.day))].sort();
            
            dayFilters.innerHTML = '';
            uniqueDays.forEach(day => {
                const div = document.createElement('div');
                div.className = 'filter-option';
                div.innerHTML = `
                    <input type="checkbox" id="day-${day}" name="day" value="${day}">
                    <label for="day-${day}">Día ${day}</label>
                `;
                dayFilters.appendChild(div);
            });
            
            document.querySelectorAll('input[name="day"]').forEach(input => {
                input.addEventListener('change', function() {
                    updateActiveFilters();
                    // Cuando se selecciona un día, actualizar actividades disponibles
                    updateActivityFilters();
                });
            });
        }

        // Actualizar filtros de actividades según día seleccionado
        function updateActivityFilters() {
            const selectedDays = Array.from(document.querySelectorAll('input[name="day"]:checked')).map(input => parseInt(input.value));
            const activityFilters = document.getElementById('activity-filters');
            
            // Obtener actividades únicas para los días seleccionados
            let activitiesToShow = [];
            if (selectedDays.length > 0) {
                activitiesToShow = [...new Set(activitiesWithLocation
                    .filter(a => selectedDays.includes(a.day))
                    .map(a => a.activity))].sort();
            } else {
                activitiesToShow = [...new Set(activitiesWithLocation.map(a => a.activity))].sort();
            }
            
            activityFilters.innerHTML = '';
            activitiesToShow.forEach(activity => {
                const div = document.createElement('div');
                div.className = 'filter-option';
                div.innerHTML = `
                    <input type="checkbox" id="${slugify(activity)}" name="activity" value="${activity}">
                    <label for="${slugify(activity)}">${currentLanguage === 'es' ? 
                        activitiesWithLocation.find(a => a.activity === activity)?.activity_es || activity : 
                        activity}</label>
                `;
                activityFilters.appendChild(div);
            });
            
            document.querySelectorAll('input[name="activity"]').forEach(input => {
                input.addEventListener('change', updateActiveFilters);
            });
        }

        // Generar filtros por participante
        function generateParticipantFilters() {
            const participantFilters = document.getElementById('participant-filters');
            const searchInput = document.getElementById('participant-search');
            
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                renderParticipantFilters(searchTerm);
            });
            
            renderParticipantFilters();
        }

        // Renderizar filtros de participantes
        function renderParticipantFilters(searchTerm = '') {
            const participantFilters = document.getElementById('participant-filters');
            participantFilters.innerHTML = '';
            
            const filteredParticipants = allParticipants.filter(p => 
                p.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            filteredParticipants.forEach(participant => {
                const div = document.createElement('div');
                div.className = 'filter-option';
                div.innerHTML = `
                    <input type="checkbox" id="${slugify(participant)}" name="participant" value="${participant}">
                    <label for="${slugify(participant)}">${participant}</label>
                `;
                participantFilters.appendChild(div);
            });
            
            document.querySelectorAll('input[name="participant"]').forEach(input => {
                input.addEventListener('change', updateActiveFilters);
            });
        }

        // Configurar botones de deseleccionar
        function setupClearButtons() {
            document.getElementById('clear-days').addEventListener('click', () => {
                document.querySelectorAll('input[name="day"]:checked').forEach(checkbox => {
                    checkbox.checked = false;
                });
                updateActiveFilters();
                updateActivityFilters();
            });
            
            document.getElementById('clear-activities').addEventListener('click', () => {
                document.querySelectorAll('input[name="activity"]:checked').forEach(checkbox => {
                    checkbox.checked = false;
                });
                updateActiveFilters();
            });
            
            document.getElementById('clear-participants').addEventListener('click', () => {
                document.querySelectorAll('input[name="participant"]:checked').forEach(checkbox => {
                    checkbox.checked = false;
                });
                updateActiveFilters();
            });
        }

        // Configurar toggle de idioma
        function setupLanguageToggle() {
            document.getElementById('lang-es').addEventListener('click', () => {
                if (currentLanguage !== 'es') {
                    currentLanguage = 'es';
                    document.getElementById('lang-es').classList.add('active');
                    document.getElementById('lang-en').classList.remove('active');
                    updateLanguage();
                }
            });
            
            document.getElementById('lang-en').addEventListener('click', () => {
                if (currentLanguage !== 'en') {
                    currentLanguage = 'en';
                    document.getElementById('lang-en').classList.add('active');
                    document.getElementById('lang-es').classList.remove('active');
                    updateLanguage();
                }
            });
        }

        // Actualizar idioma de la interfaz
        function updateLanguage() {
            document.getElementById('subtitle').textContent = translations[currentLanguage].subtitle;
            document.getElementById('days-title').textContent = translations[currentLanguage].daysTitle;
            document.getElementById('activities-title').textContent = translations[currentLanguage].activitiesTitle;
            document.getElementById('participants-title').textContent = translations[currentLanguage].participantsTitle;
            document.getElementById('participant-search').placeholder = translations[currentLanguage].searchPlaceholder;
            document.getElementById('toggle-metadata').textContent = translations[currentLanguage].showInfo;
            document.getElementById('prev-photo').textContent = translations[currentLanguage].previous;
            document.getElementById('next-photo').textContent = translations[currentLanguage].next;
            
            // Actualizar etiquetas de metadata
            document.querySelectorAll('.metadata-label').forEach((el, index) => {
                const labels = [translations[currentLanguage].date, translations[currentLanguage].place, 
                               translations[currentLanguage].activity, translations[currentLanguage].people];
                if (labels[index]) el.textContent = labels[index] + ':';
            });
            
            // Actualizar actividades en los filtros
            updateActivityFilters();
            
            // Actualizar leyenda
            updateLegend();
        }

        // Actualizar filtros activos
        function updateActiveFilters() {
            activeFilters = {
                days: Array.from(document.querySelectorAll('input[name="day"]:checked')).map(input => parseInt(input.value)),
                activities: Array.from(document.querySelectorAll('input[name="activity"]:checked')).map(input => input.value),
                participants: Array.from(document.querySelectorAll('input[name="participant"]:checked')).map(input => input.value)
            };
            
            // Mostrar/ocultar botones de deseleccionar
            document.getElementById('clear-days').style.display = activeFilters.days.length > 0 ? 'block' : 'none';
            document.getElementById('clear-activities').style.display = activeFilters.activities.length > 0 ? 'block' : 'none';
            document.getElementById('clear-participants').style.display = activeFilters.participants.length > 0 ? 'block' : 'none';
            
            createMarkers();
            updateLegend();
        }

        // Actualizar leyenda
        function updateLegend() {
            const legendItems = document.getElementById('legend-items');
            legendItems.innerHTML = '';
            
            // Mostrar leyenda solo si hay un día seleccionado
            if (activeFilters.days.length === 1) {
                const day = activeFilters.days[0];
                document.getElementById('legend-title').textContent = translations[currentLanguage].legendTitle + day;
                
                const dayActivities = activitiesWithLocation.filter(a => a.day === day);
                const activityColors = generateActivityColors(dayActivities);
                
                Object.entries(activityColors).forEach(([activity, color]) => {
                    const div = document.createElement('div');
                    div.className = 'legend-item';
                    div.innerHTML = `
                        <div class="legend-color" style="background-color: ${color};"></div>
                        <span>${currentLanguage === 'es' ? 
                            dayActivities.find(a => a.activity === activity)?.activity_es || activity : 
                            activity}</span>
                    `;
                    legendItems.appendChild(div);
                });
            } else {
                document.getElementById('legend-title').textContent = translations[currentLanguage].legendTitle;
            }
        }

        // Crear marcadores en el mapa
        function createMarkers() {
            markersCluster.clearLayers();
            const activityColors = generateActivityColors(activitiesWithLocation);
            
            activitiesWithLocation.forEach(activity => {
                // Filtrar por días, actividades y participantes seleccionados
                const dayMatch = activeFilters.days.length === 0 || activeFilters.days.includes(activity.day);
                const activityMatch = activeFilters.activities.length === 0 || activeFilters.activities.includes(activity.activity);
                
                let participantMatch = activeFilters.participants.length === 0;
                if (!participantMatch && activity.participants.length > 0) {
                    participantMatch = activeFilters.participants.some(participant => 
                        activity.participants.includes(participant)
                    );
                }
                
                if (dayMatch && activityMatch && participantMatch) {
                    // Crear marcador
                    const marker = L.marker([activity.lat, activity.lng], {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: `<div style="background-color: ${activityColors[activity.activity]}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    });
                    
                    // Añadir popup con información
                    const activityName = currentLanguage === 'es' ? activity.activity_es : activity.activity;
                    marker.bindPopup(`
                        <strong>${activity.place}</strong><br>
                        <em>${activityName}</em><br>
                        ${translations[currentLanguage].daysTitle.slice(0, -1)}: ${activity.day}<br>
                        ${activity.participants.length > 0 ? translations[currentLanguage].people + ': ' + activity.participants.join(', ') + '<br>' : ''}
                        <button onclick="showLocationPhotos('${activity.id}')">Ver fotos</button>
                    `);
                    
                    markersCluster.addLayer(marker);
                }
            });
        }

        // Simular datos de fotos (debes reemplazar con tus datos reales)
        function getPhotosForActivity(activityId) {
            const activity = allActivities.find(a => a.id === activityId);
            if (!activity) return [];
            
            // Simular algunas fotos
            const photoCount = Math.floor(Math.random() * 3) + 2;
            const photos = [];
            
            for (let i = 1; i <= photoCount; i++) {
                photos.push({
                    src: `fotos/dia${activity.day}/${slugify(activity.activity)}/foto${i}.jpg`,
                    date: activity.date,
                    place: activity.place,
                    activity: currentLanguage === 'es' ? activity.activity_es : activity.activity,
                    people: activity.participants
                });
            }
            
            return photos;
        }

        // Mostrar fotos de una actividad
        function showLocationPhotos(activityId) {
            const activity = allActivities.find(a => a.id === activityId);
            if (!activity) return;
            
            const activityName = currentLanguage === 'es' ? activity.activity_es : activity.activity;
            document.getElementById('modal-location-title').textContent = `${activity.place} - ${activityName}`;
            
            currentPhotos = getPhotosForActivity(activityId);
            currentLocationId = activityId;
            
            renderPhotoGrid();
            document.getElementById('photo-modal').style.display = 'flex';
            document.getElementById('photo-viewer').style.display = 'none';
        }

        // Renderizar grid de miniaturas
        function renderPhotoGrid() {
            const photosGrid = document.getElementById('photos-grid');
            photosGrid.innerHTML = '';
            
            if (currentPhotos.length === 0) {
                photosGrid.innerHTML = `<p>${translations[currentLanguage].noPhotos}</p>`;
                return;
            }
            
            currentPhotos.forEach((photo, index) => {
                const thumbContainer = document.createElement('div');
                const thumb = document.createElement('img');
                thumb.src = photo.src;
                thumb.alt = `Foto ${index + 1}`;
                thumb.className = 'photo-thumb';
                thumb.onclick = () => showPhotoViewer(index);
                thumbContainer.appendChild(thumb);
                photosGrid.appendChild(thumbContainer);
            });
        }

        // Mostrar foto en visor
        function showPhotoViewer(photoIndex) {
            if (photoIndex < 0 || photoIndex >= currentPhotos.length) return;
            
            currentPhotoIndex = photoIndex;
            const photo = currentPhotos[photoIndex];
            
            document.getElementById('large-photo').src = photo.src;
            document.getElementById('photo-counter').textContent = `${photoIndex + 1} / ${currentPhotos.length}`;
            document.getElementById('metadata-date').textContent = photo.date;
            document.getElementById('metadata-place').textContent = photo.place;
            document.getElementById('metadata-activity').textContent = photo.activity;
            document.getElementById('metadata-people').textContent = photo.people.join(', ');
            
            document.querySelectorAll('.photo-thumb').forEach((thumb, idx) => {
                thumb.classList.toggle('active', idx === photoIndex);
            });
            
            document.getElementById('photo-viewer').style.display = 'flex';
        }

        // Helper para crear slugs
        function slugify(text) {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^\w\-]+/g, '')
                .replace(/\-\-+/g, '-')
                .replace(/^-+/, '')
                .replace(/-+$/, '');
        }

        // ================================
        // CONFIGURACIÓN DE EVENTOS
        // ================================
        document.getElementById('prev-photo').addEventListener('click', () => {
            let newIndex = currentPhotoIndex - 1;
            if (newIndex < 0) newIndex = currentPhotos.length - 1;
            showPhotoViewer(newIndex);
        });

        document.getElementById('next-photo').addEventListener('click', () => {
            let newIndex = currentPhotoIndex + 1;
            if (newIndex >= currentPhotos.length) newIndex = 0;
            showPhotoViewer(newIndex);
        });

        document.getElementById('toggle-metadata').addEventListener('click', function() {
            const metadata = document.getElementById('photo-metadata');
            const isVisible = metadata.style.display !== 'none';
            metadata.style.display = isVisible ? 'none' : 'block';
            this.textContent = isVisible ? translations[currentLanguage].showInfo : translations[currentLanguage].hideInfo;
        });

        document.querySelector('.close-modal').addEventListener('click', () => {
            document.getElementById('photo-modal').style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            const modal = document.getElementById('photo-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

        // ================================
        // INICIALIZACIÓN
        // ================================
        function initApp() {
            generateFilters();
            updateActivityFilters();
            createMarkers();
            updateLegend();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>