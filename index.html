<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revival - Festival de Danza en el Agua</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #2c3e50;
            --color-secondary: #3498db;
            --color-accent: #e74c3c;
            --color-light: #ecf0f1;
            --color-dark: #2c3e50;
            --color-success: #2ecc71;
            --color-warning: #f39c12;
            --color-info: #9b59b6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            line-height: 1.6;
            color: var(--color-dark);
            background-color: var(--color-light);
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background-color: var(--color-primary);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .logo span {
            color: var(--color-accent);
        }

        .subtitle {
            font-size: 1rem;
            font-weight: 300;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .filters-panel {
            width: 320px;
            background: white;
            padding: 1.5rem;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .filter-section {
            margin-bottom: 1.5rem;
        }

        .filter-section h3 {
            margin-bottom: 0.8rem;
            color: var(--color-primary);
            font-size: 1.1rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }

        .search-box {
            margin-bottom: 10px;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Montserrat', sans-serif;
        }

        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-option input {
            cursor: pointer;
        }

        .filter-option label {
            cursor: pointer;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 200px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 5px;
            flex-shrink: 0;
        }

        /* Modal para mostrar fotos */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 95%;
            max-width: 1200px;
            height: 90%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            cursor: pointer;
            color: var(--color-dark);
            z-index: 2001;
            background: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .location-title {
            margin-bottom: 15px;
            color: var(--color-primary);
            text-align: center;
            padding-right: 40px;
        }

        .filters-modal {
            margin-bottom: 15px;
        }

        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-tag {
            background-color: var(--color-secondary);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }

        .photos-container {
            display: flex;
            flex: 1;
            gap: 20px;
            overflow: hidden;
        }

        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            overflow-y: auto;
            max-width: 50%;
            padding-right: 10px;
        }

        .photo-thumb {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .photo-thumb:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .photo-thumb.active {
            border: 3px solid var(--color-accent);
        }

        .photo-viewer {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        #toggle-metadata {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        .photo-viewer img {
            width: 100%;
            max-height: 60vh;
            object-fit: contain;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .photo-metadata {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .metadata-row {
            display: flex;
            margin-bottom: 8px;
        }

        .metadata-label {
            font-weight: 600;
            min-width: 80px;
            color: var(--color-primary);
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .nav-btn {
            background-color: var(--color-secondary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
        }

        .nav-btn:hover {
            background-color: var(--color-primary);
        }

        /* Responsive */
        @media (max-width: 992px) {
            .photos-container {
                flex-direction: column;
            }
            
            .photos-grid {
                max-width: 100%;
                max-height: 200px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .filters-panel {
                width: 100%;
                max-height: 300px;
            }
            
            .modal-content {
                padding: 15px;
            }
            
            .photos-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">Re<span>vival</span></div>
            <div class="subtitle">Festival de Danza en el Agua - Ibiza 2023</div>
        </header>
        
        <div class="main-content">
            <div class="filters-panel">
                <div class="filter-section">
                    <h3>Días del Evento</h3>
                    <div class="filter-options" id="day-filters">
                        <!-- Los filtros se generarán con JavaScript -->
                    </div>
                </div>
                
                <div class="filter-section">
                    <h3>Actividades</h3>
                    <div class="filter-options" id="activity-filters">
                        <!-- Los filtros se generarán con JavaScript -->
                    </div>
                </div>
                
                <div class="filter-section">
                    <h3>Participantes</h3>
                    <div class="search-box">
                        <input type="text" id="participant-search" placeholder="Buscar participante...">
                    </div>
                    <div class="filter-options" id="participant-filters">
                        <!-- Los filtros se generarán con JavaScript -->
                    </div>
                </div>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
                
                <div class="legend">
                    <h4>Leyenda</h4>
                    <div id="legend-items">
                        <!-- Los elementos de leyenda se generarán con JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para mostrar fotos -->
    <div class="modal" id="photo-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 class="location-title" id="modal-location-title"></h2>
            
            <div class="filters-modal">
                <div class="filter-tags" id="modal-filter-tags">
                    <!-- Filtros activos se mostrarán aquí -->
                </div>
            </div>
            
            <div class="photos-container">
                <div class="photos-grid" id="photos-grid">
                    <!-- Las miniaturas de fotos se insertarán aquí mediante JavaScript -->
                </div>
                
                <div class="photo-viewer" id="photo-viewer">
                    <div class="viewer-header">
                        <span id="photo-counter"></span>
                        <button id="toggle-metadata">Mostrar info</button>
                    </div>
                    <img id="large-photo" src="" alt="Foto del evento">
                    <div class="photo-metadata" id="photo-metadata">
                        <div class="metadata-row">
                            <span class="metadata-label">Fecha:</span>
                            <span id="metadata-date"></span>
                        </div>
                        <div class="metadata-row">
                            <span class="metadata-label">Lugar:</span>
                            <span id="metadata-place"></span>
                        </div>
                        <div class="metadata-row">
                            <span class="metadata-label">Actividad:</span>
                            <span id="metadata-activity"></span>
                        </div>
                        <div class="metadata-row">
                            <span class="metadata-label">Personas:</span>
                            <span id="metadata-people"></span>
                        </div>
                    </div>
                    <div class="nav-buttons">
                        <button class="nav-btn" id="prev-photo">← Anterior</button>
                        <button class="nav-btn" id="next-photo">Siguiente →</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Lista de participantes
        const allParticipants = [
            "Aitor", "Alex", "Anabel", "Andreas", "Andrew", "Annick", 
            "Anuja", "Blanca", "Claudia", "Diaana", "Dóri", "Francesco", 
            "Germán", "Jessi", "Karenina", "Laura", "Marga", "Martín", 
            "Nadia", "Natalia", "pareja", "Riki", "Tanja", "Willem"
        ];

        // Variables globales
        let allActivities = [];
        let currentLocationId = null;
        let currentPhotos = [];
        let currentPhotoIndex = 0;
        let activeFilters = {
            days: [],
            activities: [],
            participants: []
        };

        // Inicialización del mapa
        const map = L.map('map').setView([38.98, 1.30], 10);
        
        // Añadir capa del mapa
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Añadir imagen de satélite
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        }).addTo(map);
        
        // Capa para los marcadores
        const markersLayer = L.layerGroup().addTo(map);
        
        // Parsear datos CSV
        function parseCSVData() {
            // Datos extraídos del CSV proporcionado
            const activities = [
                {
                    id: "0101",
                    date: "06/08/25",
                    day: 1,
                    activity: "Opening Circle",
                    activity_es: "Círculo de apertura",
                    place: "Bosque Cala Pada",
                    lat: 38.99322,
                    lng: 1.56329,
                    participants: []
                },
                {
                    id: "0102",
                    date: "06/08/25",
                    day: 1,
                    activity: "Journey into the flow",
                    activity_es: "Viaje hacia la fluidez",
                    place: "Cala Pada",
                    lat: 38.99327,
                    lng: 1.56183,
                    participants: ["Martin", "Tanja"]
                },
                {
                    id: "0201",
                    date: "07/08/25",
                    day: 2,
                    activity: "Awaken Flow - Yoga & playful connection",
                    activity_es: "Despertar del flujo - Yoga y conexión lúdica",
                    place: "Playa S'Arenal Petit, Portinatx",
                    lat: 39.10877,
                    lng: 1.51521,
                    participants: ["Zara"]
                },
                {
                    id: "0202",
                    date: "07/08/25",
                    day: 2,
                    activity: "Water-Rebozo",
                    activity_es: "Rebozo de agua",
                    place: "Por determinar",
                    lat: 39.00181,
                    lng: 1.54227,
                    participants: ["Anuja"]
                },
                {
                    id: "0206",
                    date: "07/08/25",
                    day: 2,
                    activity: "Introduction Soma-Water Dance in Pool",
                    activity_es: "Introducción a la danza Soma-Agua en la piscina",
                    place: "Willem",
                    lat: 39.00181,
                    lng: 1.54227,
                    participants: ["Martin"]
                },
                {
                    id: "0207",
                    date: "07/08/25",
                    day: 2,
                    activity: "Ecstatic Dance",
                    activity_es: "Danza extática",
                    place: "Por determinar",
                    lat: 39.00181,
                    lng: 1.54227,
                    participants: ["Willem"]
                },
                {
                    id: "0301",
                    date: "08/08/25",
                    day: 3,
                    activity: "Morning Practice",
                    activity_es: "Práctica matutina",
                    place: "Cala Benirràs",
                    lat: 39.08958,
                    lng: 1.45463,
                    participants: ["Anuja"]
                },
                {
                    id: "0304",
                    date: "08/08/25",
                    day: 3,
                    activity: "Deep Dance Swarm among the sea weed",
                    activity_es: "Danza profunda Enjambre entre las algas",
                    place: "Por determinar",
                    lat: 39.08958,
                    lng: 1.45463,
                    participants: ["Alex"]
                },
                {
                    id: "0401",
                    date: "09/08/25",
                    day: 4,
                    activity: "Morning Practice - Soma & Voice",
                    activity_es: "Práctica matutina - Soma y voz",
                    place: "ses Salines",
                    lat: 38.83970,
                    lng: 1.39704,
                    participants: ["Rikki"]
                },
                {
                    id: "0402",
                    date: "09/08/25",
                    day: 4,
                    activity: "Partner-Water-Dance",
                    activity_es: "Danza en pareja en el agua",
                    place: "Cala Pluma",
                    lat: 38.83574,
                    lng: 1.40067,
                    participants: ["Alex"]
                },
                {
                    id: "0404",
                    date: "09/08/25",
                    day: 4,
                    activity: "Contact Improv and Water Rebozo",
                    activity_es: "Contact Improvisación y Rebozo de agua",
                    place: "Por determinar",
                    lat: 38.83574,
                    lng: 1.40067,
                    participants: ["Anuja"]
                },
                {
                    id: "0405",
                    date: "09/08/25",
                    day: 4,
                    activity: "Water Blessing Ceremony & Sunset Jam",
                    activity_es: "Ceremonia de bendición del agua y jam al atardecer",
                    place: "Por determinar",
                    lat: 38.83574,
                    lng: 1.40067,
                    participants: ["Nati"]
                },
                {
                    id: "0501",
                    date: "10/08/25",
                    day: 5,
                    activity: "Moving, Sharing, Caring, Dancing, Flowing & Closing",
                    activity_es: "Moviéndose, compartiendo, cuidando, bailando, fluyendo y cerrando",
                    place: "sa Caleta",
                    lat: 38.87005,
                    lng: 1.33973,
                    participants: []
                }
            ];
            
            return activities;
        }

        // Generar colores únicos para cada tipo de actividad
        function generateActivityColors(activities) {
            const activityTypes = [...new Set(activities.map(a => a.activity))];
            const colors = [
                '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
                '#1abc9c', '#34495e', '#e67e22', '#27ae60', '#8e44ad',
                '#d35400', '#16a085', '#c0392b', '#2980b9', '#f1c40f'
            ];
            
            const colorMap = {};
            activityTypes.forEach((type, i) => {
                colorMap[type] = colors[i % colors.length];
            });
            
            return colorMap;
        }

        // Generar filtros
        function generateFilters() {
            generateDayFilters();
            generateActivityFilters();
            generateParticipantFilters();
        }

        // Generar filtros por día
        function generateDayFilters() {
            const dayFilters = document.getElementById('day-filters');
            const uniqueDays = [...new Set(allActivities.map(a => a.day))].sort();
            
            dayFilters.innerHTML = '';
            uniqueDays.forEach(day => {
                const div = document.createElement('div');
                div.className = 'filter-option';
                div.innerHTML = `
                    <input type="checkbox" id="day-${day}" name="day" value="${day}" checked>
                    <label for="day-${day}">Día ${day}</label>
                `;
                dayFilters.appendChild(div);
            });
            
            // Añadir event listeners
            document.querySelectorAll('input[name="day"]').forEach(input => {
                input.addEventListener('change', updateActiveFilters);
            });
        }

        // Generar filtros por actividad
        function generateActivityFilters() {
            const activityFilters = document.getElementById('activity-filters');
            const uniqueActivities = [...new Set(allActivities.map(a => a.activity))].sort();
            
            activityFilters.innerHTML = '';
            uniqueActivities.forEach(activity => {
                const div = document.createElement('div');
                div.className = 'filter-option';
                div.innerHTML = `
                    <input type="checkbox" id="${slugify(activity)}" name="activity" value="${activity}" checked>
                    <label for="${slugify(activity)}">${activity}</label>
                `;
                activityFilters.appendChild(div);
            });
            
            // Añadir event listeners
            document.querySelectorAll('input[name="activity"]').forEach(input => {
                input.addEventListener('change', updateActiveFilters);
            });
        }

        // Generar filtros por participante
        function generateParticipantFilters() {
            const participantFilters = document.getElementById('participant-filters');
            const searchInput = document.getElementById('participant-search');
            
            // Función de búsqueda
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                renderParticipantFilters(searchTerm);
            });
            
            // Renderizar inicialmente
            renderParticipantFilters();
        }

        // Renderizar filtros de participantes
        function renderParticipantFilters(searchTerm = '') {
            const participantFilters = document.getElementById('participant-filters');
            participantFilters.innerHTML = '';
            
            const filteredParticipants = allParticipants.filter(p => 
                p.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            filteredParticipants.forEach(participant => {
                const div = document.createElement('div');
                div.className = 'filter-option';
                div.innerHTML = `
                    <input type="checkbox" id="${slugify(participant)}" name="participant" value="${participant}">
                    <label for="${slugify(participant)}">${participant}</label>
                `;
                participantFilters.appendChild(div);
            });
            
            // Añadir event listeners
            document.querySelectorAll('input[name="participant"]').forEach(input => {
                input.addEventListener('change', updateActiveFilters);
            });
        }

        // Actualizar filtros activos
        function updateActiveFilters() {
            activeFilters = {
                days: Array.from(document.querySelectorAll('input[name="day"]:checked')).map(input => parseInt(input.value)),
                activities: Array.from(document.querySelectorAll('input[name="activity"]:checked')).map(input => input.value),
                participants: Array.from(document.querySelectorAll('input[name="participant"]:checked')).map(input => input.value)
            };
            
            createMarkers();
            updateModalFilters();
        }

        // Actualizar filtros en el modal
        function updateModalFilters() {
            const filterTags = document.getElementById('modal-filter-tags');
            filterTags.innerHTML = '';
            
            // Añadir etiquetas para filtros activos
            activeFilters.days.forEach(day => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.innerHTML = `Día ${day} <span class="remove" onclick="removeFilter('day', ${day})">×</span>`;
                filterTags.appendChild(tag);
            });
            
            activeFilters.activities.forEach(activity => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.innerHTML = `${activity} <span class="remove" onclick="removeFilter('activity', '${activity}')">×</span>`;
                filterTags.appendChild(tag);
            });
            
            activeFilters.participants.forEach(participant => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.innerHTML = `${participant} <span class="remove" onclick="removeFilter('participant', '${participant}')">×</span>`;
                filterTags.appendChild(tag);
            });
        }

        // Remover filtro
        function removeFilter(type, value) {
            const selector = type === 'day' ? 
                `input[name="${type}"][value="${value}"]` :
                `input[name="${type}"][value="${value}"]`;
            
            const input = document.querySelector(selector);
            if (input) {
                input.checked = false;
                updateActiveFilters();
            }
        }

        // Crear marcadores para cada ubicación
        function createMarkers() {
            markersLayer.clearLayers();
            const activityColors = generateActivityColors(allActivities);
            
            allActivities.forEach(activity => {
                // Filtrar por días, actividades y participantes seleccionados
                const dayMatch = activeFilters.days.length === 0 || activeFilters.days.includes(activity.day);
                const activityMatch = activeFilters.activities.length === 0 || activeFilters.activities.includes(activity.activity);
                
                let participantMatch = activeFilters.participants.length === 0;
                if (!participantMatch) {
                    participantMatch = activeFilters.participants.some(participant => 
                        activity.participants.includes(participant)
                    );
                }
                
                if (dayMatch && activityMatch && participantMatch) {
                    // Crear marcadores personalizados
                    const marker = L.marker([activity.lat, activity.lng], {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: `<div style="background-color: ${activityColors[activity.activity]}; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        })
                    });
                    
                    // Añadir popup con información básica
                    marker.bindPopup(`
                        <strong>${activity.place}</strong><br>
                        <em>${activity.activity}</em><br>
                        Día: ${activity.day}<br>
                        ${activity.participants.length > 0 ? 'Participantes: ' + activity.participants.join(', ') + '<br>' : ''}
                        <button onclick="showLocationPhotos('${activity.id}')">Ver fotos</button>
                    `);
                    
                    marker.addTo(markersLayer);
                }
            });
        }

        // Simular datos de fotos (debes reemplazar esto con tus datos reales)
        function getPhotosForActivity(activityId) {
            // Esta función simula la carga de fotos
            // En la implementación real, deberías tener un mapeo entre actividades y fotos
            const activity = allActivities.find(a => a.id === activityId);
            if (!activity) return [];
            
            // Simular 3-8 fotos por actividad
            const photoCount = Math.floor(Math.random() * 6) + 3;
            const photos = [];
            
            for (let i = 1; i <= photoCount; i++) {
                photos.push({
                    src: `fotos/dia${activity.day}/${slugify(activity.activity)}/foto${i}.jpg`,
                    date: activity.date,
                    place: activity.place,
                    activity: activity.activity,
                    people: activity.participants.concat([randomParticipant()]).filter((v, i, a) => a.indexOf(v) === i)
                });
            }
            
            return photos;
        }

        // Helper para obtener un participante aleatorio
        function randomParticipant() {
            return allParticipants[Math.floor(Math.random() * allParticipants.length)];
        }

        // Mostrar fotos de una ubicación en el modal
        function showLocationPhotos(activityId) {
            const activity = allActivities.find(a => a.id === activityId);
            if (!activity) return;
            
            document.getElementById('modal-location-title').textContent = `${activity.place} - ${activity.activity}`;
            
            // Obtener fotos para esta actividad
            currentPhotos = getPhotosForActivity(activityId);
            currentLocationId = activityId;
            
            renderPhotoGrid();
            
            // Mostrar modal
            document.getElementById('photo-modal').style.display = 'flex';
            document.getElementById('photo-viewer').style.display = 'none';
        }

        // Renderizar grid de miniaturas
        function renderPhotoGrid() {
            const photosGrid = document.getElementById('photos-grid');
            photosGrid.innerHTML = '';
            
            if (currentPhotos.length === 0) {
                photosGrid.innerHTML = '<p>No hay fotos para esta actividad</p>';
                return;
            }
            
            // Crear miniaturas de fotos
            currentPhotos.forEach((photo, index) => {
                const thumbContainer = document.createElement('div');
                thumbContainer.className = 'photo-thumb-container';
                
                const thumb = document.createElement('img');
                thumb.src = photo.src;
                thumb.alt = `Foto ${index + 1}`;
                thumb.className = 'photo-thumb';
                thumb.onclick = () => showPhotoViewer(index);
                
                thumbContainer.appendChild(thumb);
                photosGrid.appendChild(thumbContainer);
            });
        }

        // Mostrar foto en tamaño grande
        function showPhotoViewer(photoIndex) {
            if (photoIndex < 0 || photoIndex >= currentPhotos.length) return;
            
            currentPhotoIndex = photoIndex;
            const photo = currentPhotos[photoIndex];
            
            // Actualizar visor de foto
            document.getElementById('large-photo').src = photo.src;
            document.getElementById('photo-counter').textContent = `${photoIndex + 1} / ${currentPhotos.length}`;
            
            // Actualizar metadatos
            document.getElementById('metadata-date').textContent = photo.date;
            document.getElementById('metadata-place').textContent = photo.place;
            document.getElementById('metadata-activity').textContent = photo.activity;
            document.getElementById('metadata-people').textContent = photo.people.join(', ');
            
            // Resaltar miniatura activa
            document.querySelectorAll('.photo-thumb').forEach((thumb, idx) => {
                thumb.classList.toggle('active', idx === photoIndex);
            });
            
            // Mostrar visor
            document.getElementById('photo-viewer').style.display = 'flex';
            
            // Desplazar a la miniatura activa
            const activeThumb = document.querySelectorAll('.photo-thumb')[photoIndex];
            if (activeThumb) {
                activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // Navegar a foto anterior
        document.getElementById('prev-photo').addEventListener('click', () => {
            let newIndex = currentPhotoIndex - 1;
            if (newIndex < 0) newIndex = currentPhotos.length - 1;
            showPhotoViewer(newIndex);
        });

        // Navegar a foto siguiente
        document.getElementById('next-photo').addEventListener('click', () => {
            let newIndex = currentPhotoIndex + 1;
            if (newIndex >= currentPhotos.length) newIndex = 0;
            showPhotoViewer(newIndex);
        });

        // Alternar metadatos
        document.getElementById('toggle-metadata').addEventListener('click', function() {
            const metadata = document.getElementById('photo-metadata');
            const isVisible = metadata.style.display !== 'none';
            metadata.style.display = isVisible ? 'none' : 'block';
            this.textContent = isVisible ? 'Mostrar info' : 'Ocultar info';
        });

        // Cerrar modal
        document.querySelector('.close-modal').addEventListener('click', () => {
            document.getElementById('photo-modal').style.display = 'none';
        });

        // Cerrar modal al hacer clic fuera del contenido
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('photo-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Helper para crear slugs
        function slugify(text) {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-')           // Replace spaces with -
                .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
                .replace(/\-\-+/g, '-')         // Replace multiple - with single -
                .replace(/^-+/, '')             // Trim - from start of text
                .replace(/-+$/, '');            // Trim - from end of text
        }

        // Inicializar la aplicación
        function initApp() {
            allActivities = parseCSVData();
            generateFilters();
            createMarkers();
            
            // Inicializar leyenda
            const activityColors = generateActivityColors(allActivities);
            const legendItems = document.getElementById('legend-items');
            legendItems.innerHTML = '';
            
            Object.entries(activityColors).forEach(([activity, color]) => {
                const div = document.createElement('div');
                div.className = 'legend-item';
                div.innerHTML = `
                    <div class="legend-color" style="background-color: ${color};"></div>
                    <span>${activity}</span>
                `;
                legendItems.appendChild(div);
            });
        }

        // Iniciar cuando el DOM esté cargado
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>